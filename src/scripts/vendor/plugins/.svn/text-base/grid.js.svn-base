(function($) {

  $.fn.Grid = function(options) {

    var grids = this;

    grids.each(function () {

      var grid = $(this);
      var content = grid.children('.Content');
      var header = grid.children('.GridHeader');
      var status;

      function init () {

        // Append loading indicator
        grid.append('<div class="Status" style="display: none"><div class="LoadIcon"></div><div class="LoadText">Loading</div></div>');

        // Load callback
        if (options.onload !== undefined) {
          options.onload();
        }

        // Scoll end callback
        if (options.infiniteScroll !== undefined) {
          content.on('scroll', function () {
            if($(this).scrollTop() + $(this).innerHeight() >= this.scrollHeight) {
              loading(true);
              options.infiniteScroll();
            }
          });
        }

        offsetScrollbars();

      }

      // Offset Scrollbars
      function offsetScrollbars () {

        if (header.length > 0) {

          var lastColumn = grid.find('th:last');
          var scrollbarWidth = content.width() - content.children(0).width();

          if(scrollbarWidth > 0) {
            lastColumn.css('width', lastColumn.width() + scrollbarWidth);
          }

        }

      }

      function loading (show) {

        var status = grid.children('.Status');

        if(show) {
          status.show();
        }
        else {
          status.hide();
        }

      }

      // Append content
      function appendContent (html) {
        content.append(html);
        loading(false);
        offsetScrollbars();
      }

      init();

    });

  };

})(jQuery);